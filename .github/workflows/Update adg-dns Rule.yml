name: Update adg-dns Rule

on: 
  schedule:
    - cron: "0 0,8,16 * * *"
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  update-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download and process rules
        run: |
          # 下载规则文件
          curl -o adblockdns.txt https://raw.githubusercontent.com/217heidai/adblockfilters/main/rules/adblockdns.txt
          curl -o awavenue_ads_rule_singbox.json https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox-regex.json

          # 清理JSON注释并提取域名和正则
          sed '/^\/\/.*$/d' awavenue_ads_rule_singbox.json > awavenue_ads_rule_clean.json
          jq -r '.rules[].domain[]' awavenue_ads_rule_clean.json > extracted_domains.txt
          jq -r '.rules[].domain_regex[]' awavenue_ads_rule_clean.json > extracted_regex.txt

          # 合并规则文件
          cat adblockdns.txt extracted_domains.txt > combined_rules.txt

          # 处理黑名单和白名单
          grep '^\|\|' combined_rules.txt | sed 's/^||//; s/\^$//' | sort -u > new_blacklist.txt
          grep '^@@||' combined_rules.txt | sed 's/^@@||//; s/\^$//' | sort -u > temp_whitelist.txt
          cat temp_whitelist.txt noblock.txt | sort -u > whitelist.txt
          grep -vxFf whitelist.txt new_blacklist.txt > blacklist.txt

      - name: Create adg-dns.json
        run: |
          # 将正则表达式转换为JSON数组
          if [ -s extracted_regex.txt ]; then
            echo '[' > regex_array.json
            sed 's/.*/"&",/' extracted_regex.txt | sed '$ s/,$//' >> regex_array.json
            echo ']' >> regex_array.json
            jq . regex_array.json > valid_regex.json
          else
            echo '[]' > valid_regex.json
          fi

          # 将域名转换为JSON数组
          echo '[' > domain_array.json
          sed 's/.*/"&",/' blacklist.txt | sed '/^"@@/d; $ s/,$//' >> domain_array.json
          echo ']' >> domain_array.json
          jq . domain_array.json > valid_domains.json

          # 生成最终JSON（严格保持domain_suffix在前）
          jq -n \
            --argjson version 2 \
            --slurpfile domains valid_domains.json \
            --slurpfile regex valid_regex.json \
            '{
              version: $version,
              rules: [
                {
                  domain_suffix: $domains[0],
                  domain_regex: $regex[0]
                }
              ]
            }' > adg-dns.json

          # 清理临时文件
          rm -f regex_array.json valid_regex.json domain_array.json valid_domains.json

          # 格式化验证
          jq . adg-dns.json > formatted_adg-dns.json
          mv formatted_adg-dns.json adg-dns.json

      - name: Debug adg-dns.json
        run: cat adg-dns.json

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add adg-dns.json
          git commit -m "Update DNS rules (domain_suffix first)" || echo "No changes to commit"
          git push

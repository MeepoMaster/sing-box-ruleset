name: Convert Emby JSON and AdGuard filters to SRS

on:
  push:
    paths:
      - 'emby.json'
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"  # 每天 UTC 时间 00:00 运行

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup sing-box (pre-release)
      run: |
        LATEST_PRE_VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases | jq -r '[.[] | select(.prerelease == true)][0].tag_name')
        echo "Latest sing-box pre-release version: $LATEST_PRE_VERSION"
        wget https://github.com/SagerNet/sing-box/releases/download/${LATEST_PRE_VERSION}/sing-box-${LATEST_PRE_VERSION#v}-linux-amd64.tar.gz
        tar -xzvf sing-box-${LATEST_PRE_VERSION#v}-linux-amd64.tar.gz
        sudo mv sing-box-${LATEST_PRE_VERSION#v}-linux-amd64/sing-box /usr/local/bin/
        sing-box version

    - name: Convert Emby JSON to SRS
      run: |
        if [ -f emby.json ]; then
          sing-box rule-set compile --output emby.srs emby.json
        else
          echo "emby.json not found, skipping Emby conversion"
        fi

    - name: Download and merge AdGuard filters
      run: |
        combined_filters="combined_adguard_filters.txt"
        > $combined_filters  # 创建一个空文件
        filters=(
          "https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt"
          "https://adguardteam.github.io/HostlistsRegistry/assets/filter_2.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_24.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_4.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_34.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_27.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_32.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_3.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_29.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_33.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_30.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_11.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_12.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_9.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_8.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_31.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_10.txt"
          #"https://adguardteam.github.io/HostlistsRegistry/assets/filter_53.txt"
          "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt"
          "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/MobileFilter/sections/specific_app.txt"
          "https://adaway.org/hosts.txt"
          "https://someonewhocares.org/hosts/zero/hosts"
          "https://raw.githubusercontent.com/crazy-max/WindowsSpyBlocker/master/data/hosts/spy.txt"
          "https://raw.githubusercontent.com/durablenapkin/scamblocklist/master/adguard.txt"
          "https://raw.githubusercontent.com/mitchellkrogza/The-Big-List-of-Hacked-Malware-Web-Sites/master/hosts"
          "https://malware-filter.gitlab.io/malware-filter/urlhaus-filter-agh.txt"
          "https://raw.githubusercontent.com/ABPindo/indonesianadblockrules/master/subscriptions/abpindo.txt"
          "https://raw.githubusercontent.com/yous/YousList/master/hosts.txt"
          "https://raw.githubusercontent.com/DandelionSprout/adfilt/master/NorwegianExperimentalList%20alternate%20versions/NordicFiltersAdGuardHome.txt"
          "https://raw.githubusercontent.com/DandelionSprout/adfilt/master/Alternate%20versions%20Anti-Malware%20List/AntiMalwareAdGuardHome.txt"
          "https://raw.githubusercontent.com/MajkiIT/polish-ads-filter/master/polish-pihole-filters/hostfile.txt"
          "https://raw.githubusercontent.com/lassekongo83/Frellwits-filter-lists/master/Frellwits-Swedish-Hosts-File.txt"
          "https://anti-ad.net/easylist.txt"
          "https://easylist-downloads.adblockplus.org/easylistdutch.txt"
          "https://raw.githubusercontent.com/DRSDavidSoft/additional-hosts/master/domains/blacklist/unwanted-iranian.txt"
          "https://raw.githubusercontent.com/cchevy/macedonian-pi-hole-blocklist/master/hosts.txt"
          "https://paulgb.github.io/BarbBlock/blacklists/hosts-file.txt"
          "https://winhelp2002.mvps.org/hosts.txt"
          "https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/filters.txt"
          "https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/badware.txt"
          "https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/privacy.txt"
          "https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/resource-abuse.txt"
          "https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/unbreak.txt"
          "https://big.oisd.nl"
          "https://www.github.developerdan.com/hosts/lists/ads-and-tracking-extended.txt"
          "https://www.github.developerdan.com/hosts/lists/facebook-extended.txt"
          "https://www.github.developerdan.com/hosts/lists/amp-hosts-extended.txt"
          "https://www.github.developerdan.com/hosts/lists/dating-services-extended.txt"
          "https://www.github.developerdan.com/hosts/lists/tracking-aggressive-extended.txt"
          "https://raw.githubusercontent.com/PolishFiltersTeam/KADhosts/master/KADhosts.txt"
          "https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.Spam/hosts"
          "https://v.firebog.net/hosts/static/w3kbl.txt"
          "https://v.firebog.net/hosts/neohostsbasic.txt"
          "https://v.firebog.net/hosts/AdguardDNS.txt"
          "https://v.firebog.net/hosts/Admiral.txt"
          "https://v.firebog.net/hosts/Easylist.txt"
          "https://v.firebog.net/hosts/Prigent-Crypto.txt"
          "https://v.firebog.net/hosts/Prigent-Malware.txt"
          "https://raw.githubusercontent.com/matomo-org/referrer-spam-blacklist/master/spammers.txt"
          "https://raw.githubusercontent.com/matomo-org/referrer-spam-list/master/spammers.txt"
          "https://raw.githubusercontent.com/VeleSila/yhosts/master/hosts"
          "https://raw.githubusercontent.com/RooneyMcNibNug/pihole-stuff/master/SNAFU.txt"
          "https://raw.githubusercontent.com/anudeepND/blacklist/master/adservers.txt"
          "https://raw.githubusercontent.com/anudeepND/blacklist/master/facebook.txt"
          "https://s3.amazonaws.com/lists.disconnect.me/simple_ad.txt"
          "https://pgl.yoyo.org/adservers/serverlist.php?hostformat=adblockplus&showintro=1&mimetype=plaintext"
          "https://raw.githubusercontent.com/Perflyst/PiHoleBlocklist/master/SmartTV-AGH.txt"
          "https://raw.githubusercontent.com/Spam404/lists/master/main-blacklist.txt"
          "https://raw.githubusercontent.com/Spam404/lists/master/adblock-list.txt"
          "https://raw.githubusercontent.com/DandelionSprout/adfilt/master/GameConsoleAdblockList.txt"
          "https://raw.githubusercontent.com/hoshsadiq/adblock-nocoin-list/master/hosts.txt"
          "https://abpvn.com/android/abpvn.txt"
          "https://raw.githubusercontent.com/FadeMind/hosts.extras/master/UncheckyAds/hosts"
          "https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.Risk/hosts"
          "https://raw.githubusercontent.com/bigdargon/hostsVN/master/hosts"
          "https://raw.githubusercontent.com/jdlingyu/ad-wars/master/hosts"
          "https://osint.digitalside.it/Threat-Intel/lists/latestdomains.txt"
          "https://bitbucket.org/ethanr/dns-blacklists/raw/8575c9f96e5b4a1308f2f12394abd86d0927a4a0/bad_lists/Mandiant_APT1_Report_Appendix_D.txt"
          "https://gitlab.com/quidsup/notrack-blocklists/raw/master/notrack-malware.txt"
          "https://urlhaus.abuse.ch/downloads/hostfile/"
          "https://zerodot1.gitlab.io/CoinBlockerLists/hosts_browser"
          "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"
          "https://easylist-downloads.adblockplus.org/antiadblockfilters.txt"
          "https://easylist-downloads.adblockplus.org/abp-filters-anti-cv.txt"
          "https://raw.githubusercontent.com/AdguardTeam/cname-trackers/master/data/combined_disguised_trackers.txt"
          "https://secure.fanboy.co.nz/fanboy-cookiemonster.txt"
          "https://easylist.to/easylist/easyprivacy.txt"
          "https://raw.githubusercontent.com/nextdns/cname-cloaking-blocklist/master/domains"
          "https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/alexa"
          "https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/apple"
          "https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/huawei"
          "https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/roku"
          "https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/samsung"
          "https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/sonos"
          "https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/windows"
          "https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/xiaomi"
          "https://hostfiles.frogeye.fr/firstparty-trackers-hosts.txt"
          "https://v.firebog.net/hosts/Easyprivacy.txt"
          "https://v.firebog.net/hosts/Prigent-Ads.txt"
          "https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.2o7Net/hosts"
          "https://s3.amazonaws.com/lists.disconnect.me/simple_malvertising.txt"
          "https://malware-filter.gitlab.io/malware-filter/phishing-filter-agh.txt"
          "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/multi.txt"
          "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/doh-vpn-proxy-bypass.txt"
          "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/fake.txt"
          "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.txt"
          "https://dl.red.flag.domains/red.flag.domains.txt"
        )
        
        for filter in "${filters[@]}"; do
          wget -O - "$filter" >> $combined_filters || echo "下载 $filter 失败，继续"
        done

    - name: Convert combined AdGuard filters to adg-dns.srs
      run: |
        sing-box rule-set convert --type adguard --output adg-dns.srs combined_adguard_filters.txt

    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add emby.srs adg-dns.srs
        git commit -m "Convert Emby JSON and merge AdGuard filters to adg-dns.srs" || echo "No changes to commit"
        git push

    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        name: sing-box-rule-sets
        path: |
          emby.srs
          adg-dns.srs
